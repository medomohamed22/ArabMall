<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>موقع تبرعات Pi Network</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    button {
      padding: 12px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: purple;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>تبرع باستخدام Pi Network</h2>
    <button id="payBtn">تبرع الآن</button>
    <p id="status"></p>
  </div>

  <script>
    const backendUrl = "http://localhost:3000"; // غيّرها لرابط السيرفر الحقيقي بعد الرفع

    // تهيئة SDK
    Pi.init({ version: "2.0" });

    document.getElementById("payBtn").onclick = async () => {
      document.getElementById("status").innerText = "جاري تسجيل الدخول...";

      try {
        // تسجيل الدخول
        const scopes = ['payments'];
        const user = await Pi.authenticate(scopes, onIncompletePaymentFound);
        console.log("User:", user);

        document.getElementById("status").innerText = "جاري إنشاء الدفع...";

        // إنشاء عملية دفع
        const payment = await Pi.createPayment({
          amount: 1, // قيمة التبرع Pi
          memo: "تبرع للموقع",
          metadata: { custom: "data" }
        });

        console.log("Payment created:", payment);
        document.getElementById("status").innerText = "تم إنشاء الدفع. بانتظار الإتمام...";

        // إرسال الـ paymentId للسيرفر للموافقة
        await fetch(`${backendUrl}/approve_payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId: payment.identifier })
        });

        // عند اكتمال الدفع (txid)
        Pi.openPayment(payment.identifier, {
          onReadyForServerApproval: async (paymentId) => {
            console.log("Ready for server approval:", paymentId);
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            console.log("Ready for server completion:", paymentId, txid);
            await fetch(`${backendUrl}/complete_payment`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
            document.getElementById("status").innerText = "✅ تم الدفع بنجاح!";
          },
          onCancel: (paymentId) => {
            console.log("الدفع تم إلغاؤه:", paymentId);
            document.getElementById("status").innerText = "❌ تم إلغاء الدفع.";
          },
          onError: (error, payment) => {
            console.error("خطأ:", error);
            document.getElementById("status").innerText = "⚠️ حدث خطأ أثناء الدفع.";
          }
        });

      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "فشل تسجيل الدخول أو الدفع.";
      }
    };

    // في حالة دفع غير مكتمل
    function onIncompletePaymentFound(payment) {
      console.log("Incomplete payment:", payment);
    }
  </script>
</body>
</html>
