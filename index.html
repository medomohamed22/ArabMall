<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donate Way</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
:root {
    --primary:#7b3fe4;
    --bg:#f4f6f8;
    --card:#fff;
    --text:#222;
}
body.dark {
    --bg:#121212;
    --card:#1e1e1e;
    --text:#eee;
}
body {
    margin:0;
    font-family:Segoe UI,Arial;
    background:var(--bg);
    color:var(--text);
    transition:.3s;
}
.container {
    max-width:420px;
    margin:auto;
    padding:15px;
}
.card {
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-top:15px;
    box-shadow:0 8px 20px rgba(0,0,0,.08);
}
.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.toggle {cursor:pointer}
h2,h3 {margin:0 0 10px}
.user {text-align:center;font-weight:bold}
input,button {
    width:100%;
    padding:14px;
    border-radius:10px;
    font-size:16px;
    margin-top:10px;
}
input {
    border:1px solid #ccc;
    background:transparent;
    color:var(--text);
}
button {
    background:var(--primary);
    color:#fff;
    border:none;
    cursor:pointer;
}
.badge {
    background:var(--primary);
    color:#fff;
    padding:6px 10px;
    border-radius:20px;
    font-size:12px;
}
.small {font-size:13px;opacity:.8}
</style>
</head>

<body>
<div class="container">

<div class="header">
    <h2>Donate Way ğŸ’œ</h2>
    <div class="toggle" onclick="toggleMode()">ğŸŒ“</div>
</div>

<div class="card">
    <div class="user" id="user">Guest</div>
    <div class="small" style="text-align:center">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¨Ø±Ø¹Ø§ØªÙƒ: <b id="total">0</b> Pi
    </div>
</div>

<div class="card">
    <h3>ØªØ¨Ø±Ø¹ Ø§Ù„Ø¢Ù†</h3>
    <input type="number" id="amount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¨Ø±Ø¹ (Pi)" min="0.01" step="0.01">
    <button onclick="donate()">ØªØ¨Ø±Ø¹ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
</div>

<div class="card">
    <h3>ğŸ–ï¸ Ø´Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¨Ø±Ø¹</h3>
    <div id="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>
</div>

<div class="card">
    <h3>ğŸ§¾ ØªØ¨Ø±Ø¹Ø§ØªÙƒ</h3>
    <ul id="history"></ul>
</div>

</div>

<script>
// ğŸ”´ Real Payments
Pi.init({ version:"2.0", sandbox:false });

let user = localStorage.getItem("pi_user") || "Guest";
let donations = JSON.parse(localStorage.getItem("donations") || "[]");

updateUI();

function toggleMode(){
    document.body.classList.toggle("dark");
}

async function donate(){
    const amount = Number(document.getElementById("amount").value);
    if (!amount || amount <= 0) {
        alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
        return;
    }

    // ğŸ”‘ Authenticate ÙˆÙ‚Øª Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
    try {
        const auth = await Pi.authenticate(['username','payments']);
        if (auth.username) {
            user = auth.username;
            localStorage.setItem("pi_user", user);
            updateUI();
        }
    } catch(e){
        console.log("Guest payment");
    }

    Pi.createPayment({
        amount: amount,
        memo: "Donate Way Donation",
        metadata: {
            donor: user,
            source: "DonateWay"
        }
    },{
        // âœ… Ø­Ù‚ÙŠÙ‚ÙŠ
        onReadyForServerApproval: async (paymentId) => {
            await fetch("/api/pi/approve", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ paymentId })
            });
        },

        // âœ… Ø­Ù‚ÙŠÙ‚ÙŠ
        onReadyForServerCompletion: async (paymentId, txid) => {
            await fetch("/api/pi/complete", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ paymentId, txid })
            });

            donations.push({ amount, txid });
            localStorage.setItem("donations", JSON.stringify(donations));
            updateUI();
            alert("ØªÙ… Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        },

        onCancel: () => alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"),
        onError: e => alert(e.message)
    });
}

function updateUI(){
    document.getElementById("user").innerText = user;
    const total = donations.reduce((s,d)=>s+d.amount,0);
    document.getElementById("total").innerText = total;

    const list = document.getElementById("history");
    list.innerHTML = "";
    donations.forEach(d=>{
        list.innerHTML += `<li>${d.amount} Pi</li>`;
    });

    let badge = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
    if (total >= 50) badge = "ğŸ’ Ù…ØªØ¨Ø±Ø¹ Ù…Ø§Ø³ÙŠ";
    else if (total >= 20) badge = "ğŸ¥‡ Ù…ØªØ¨Ø±Ø¹ Ø°Ù‡Ø¨ÙŠ";
    else if (total >= 5) badge = "ğŸ¥ˆ Ù…ØªØ¨Ø±Ø¹ ÙØ¶ÙŠ";
    document.getElementById("badge").innerHTML =
        `<span class="badge">${badge}</span>`;
}
</script>
</body>
</html>
