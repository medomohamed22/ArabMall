<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تجربة دفع شبكة Pi</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#db4938">
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            direction: rtl;
        }
        .container {
            text-align: center;
        }
        input[type="number"] {
            padding: 10px;
            margin: 10px 0;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
        }
        #error, #status {
            margin: 10px 0;
            font-weight: bold;
        }
        #error {
            color: red;
        }
        #status {
            color: blue;
        }
    </style>
</head>
<body>
    <div class="container form-group">
        <h1>تجربة دفع شبكة Pi</h1>
        <div id="username">يرجى تسجيل الدخول</div>
        <input id="pi_donate" name="pi_donate" class="form-control" type="number" min="0.01" step="0.01" lang="ar-SA" placeholder="أدخل كمية Pi"/>
        <input id="button_click" name="button_click" value="إتمام الدفع" type="button" class="btn btn-primary mt-2"/>
        <div id="status"></div>
        <div id="error"></div>
    </div>

    <script>
        // رابط السيرفر (غيره للرابط الحقيقي في الإنتاج)
        const BACKEND_URL = 'http://localhost:3314'; // استبدل برابط الخادم (مثل https://your-server.com)

        // التأكد من تحميل Pi SDK
        if (typeof Pi === 'undefined') {
            $('#error').text('فشل تحميل Pi SDK. تحقق من الاتصال بالإنترنت');
            throw new Error('Pi SDK not loaded');
        }

        // تهيئة Pi SDK
        Pi.init({ version: "2.0" });

        // مصادقة المستخدم
        const scopes = ['username', 'payments'];
        function onIncompletePaymentFound(payment) {
            console.log("دفع غير مكتمل:", payment);
            return axios.post(`${BACKEND_URL}/pi/incomplete`, {
                action: 'incomplete',
                paymentId: payment.identifier,
                app_client: 'pi_payment_app'
            })
            .then(response => {
                console.log("استجابة الدفع غير المكتمل:", response.data);
                return response.data;
            })
            .catch(error => {
                console.error("خطأ في الدفع غير المكتمل:", error.message);
                throw error;
            });
        }

        Pi.authenticate(scopes, onIncompletePaymentFound)
            .then(auth => {
                $('#username').text(`مرحبًا، ${auth.user.username}! جاهز لإجراء الدفعات`);
            })
            .catch(error => {
                $('#error').text(`فشل تسجيل الدخول: ${error.message}`);
                console.error("خطأ في المصادقة:", error);
            });

        // دالة إنشاء الدفع
        $('#button_click').click(async function() {
            const button = $(this);
            const errorDiv = $('#error');
            const statusDiv = $('#status');
            const amount = parseFloat($('#pi_donate').val());

            // تنظيف الرسائل السابقة
            errorDiv.text('');
            statusDiv.text('');

            // التحقق من المبلغ
            if (isNaN(amount) || amount <= 0 || amount > 10000) {
                errorDiv.text('يرجى إدخال كمية صالحة من Pi (بين 0.01 و 10000)');
                return;
            }

            // تعطيل الزر وإظهار حالة التحميل
            button.prop('disabled', true).val('جاري المعالجة...');
            statusDiv.text('جاري إنشاء الدفع...');

            try {
                const paymentData = {
                    amount: amount,
                    memo: "دفع تجريبي",
                    metadata: { paymentType: "donation", orderId: `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` }
                };

                const payment = await Pi.createPayment(paymentData, {
                    onReadyForServerApproval: async (paymentId) => {
                        statusDiv.text('جاري الموافقة على الدفع...');
                        try {
                            const response = await axios.post(`${BACKEND_URL}/pi/approve`, {
                                action: 'approve',
                                paymentId: paymentId,
                                app_client: 'pi_payment_app'
                            });
                            console.log("تمت الموافقة:", response.data);
                            statusDiv.text('تمت الموافقة على الدفع!');
                        } catch (error) {
                            errorDiv.text(`خطأ في الموافقة: ${error.message}`);
                            console.error("خطأ في الموافقة:", error);
                        }
                    },
                    onReadyForServerCompletion: async (paymentId, txid) => {
                        statusDiv.text('جاري إكمال الدفع...');
                        try {
                            const response = await axios.post(`${BACKEND_URL}/pi/complete`, {
                                action: 'complete',
                                paymentId: paymentId,
                                txid: txid,
                                app_client: 'pi_payment_app'
                            });
                            console.log("تم الإكمال:", response.data);
                            statusDiv.text('تم إكمال الدفع بنجاح!');
                        } catch (error) {
                            errorDiv.text(`خطأ في الإكمال: ${error.message}`);
                            console.error("خطأ في الإكمال:", error);
                        }
                    },
                    onCancel: (paymentId) => {
                        errorDiv.text('تم إلغاء الدفع');
                        console.log("إلغاء الدفع:", paymentId);
                    },
                    onError: (error, payment) => {
                        let message = 'خطأ في الدفع';
                        if (error.message.includes('network')) {
                            message = 'فشل الاتصال بالخادم. يرجى المحاولة لاحقًا';
                        } else if (error.message.includes('cancelled')) {
                            message = 'تم إلغاء الدفع من قبل المستخدم';
                        }
                        errorDiv.text(message);
                        console.error("خطأ:", error, payment);
                    }
                });
            } catch (error) {
                errorDiv.text(`خطأ في إنشاء الدفع: ${error.message}`);
                console.error("خطأ في إنشاء الدفع:", error);
            } finally {
                // إعادة تفعيل الزر
                button.prop('disabled', false).val('إتمام الدفع');
            }
        });
    </script>
</body>
</html>
