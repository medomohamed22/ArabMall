<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Donate Way — منصة التبرعات</title>
  <!-- Pi Network Platform SDK (يعمل بالكامل داخل Pi Browser) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    :root {
      --bg: #0f0a1f;
      --card: #15102b;
      --white: #ffffff;
      --muted: #c7bdf1;
      --purple-900:#3c0b86;
      --purple-700:#6a24ff;
      --purple-600:#7a3cff;
      --purple-500:#8b5cf6;
      --purple-400:#a78bfa;
      --ring: rgba(138,92,246,.5);
      --success:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--white);
      background: radial-gradient(1000px 600px at 50% -10%, rgba(167,139,250,.2), transparent 55%),
                  radial-gradient(800px 500px at 120% 20%, rgba(124,58,237,.15), transparent 60%), var(--bg);
    }
    a{color:var(--purple-400);text-decoration:none}
    .container{max-width:1060px;margin:0 auto;padding:24px}
    .nav{position:sticky;top:0;z-index:40;backdrop-filter:blur(8px);background:linear-gradient(to bottom,rgba(10,5,25,.7),rgba(10,5,25,.2));border-bottom:1px solid rgba(255,255,255,.06)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;background:conic-gradient(from 210deg,var(--purple-700),var(--purple-400));box-shadow:0 10px 30px rgba(124,58,237,.35), inset 0 0 16px rgba(255,255,255,.18)}
    .tag{font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.03)}.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:22px;align-items:stretch}
@media (max-width:900px){.hero{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);border-radius:24px;padding:22px}
.heading{font-size:clamp(28px,3.2vw,42px);line-height:1.15;margin:2px 0 10px}
.sub{color:var(--muted);margin:0 0 18px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){.grid-2{grid-template-columns:1fr}}

.input,.select,.btn{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--white);box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)}
.input::placeholder{color:rgba(255,255,255,.55)}

.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{cursor:pointer;user-select:none;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03)}
.chip.active{background:linear-gradient(90deg,var(--purple-700),var(--purple-500));box-shadow:0 6px 18px rgba(124,58,237,.35)}

.btn{cursor:pointer;font-weight:800;letter-spacing:.2px;transition:transform .05s ease}
.btn.primary{background:linear-gradient(90deg,var(--purple-700),var(--purple-500));border-color:transparent}
.btn.ghost{background:rgba(255,255,255,.04)}
.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.separator{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:16px 0}

.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:14px 0 8px}
.stat{padding:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;text-align:center}
.stat .v{font-weight:800;font-size:18px}
.stat .k{font-size:12px;color:var(--muted)}

.list{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;padding-right:4px}
.donor{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
.avatar{width:38px;height:38px;border-radius:12px;background:linear-gradient(180deg,var(--purple-400),var(--purple-700));display:grid;place-items:center;font-weight:800}
.donor small{color:var(--muted)}

.toast-area{position:fixed;inset-inline:0;bottom:16px;display:grid;place-items:center;pointer-events:none}
.toast{pointer-events:auto;display:flex;gap:10px;align-items:center;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);background:rgba(21,16,43,.8);box-shadow:0 10px 30px rgba(0,0,0,.35)}
.badge{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
.ok{background:rgba(22,163,74,.18)}.warn{background:rgba(245,158,11,.18)}.err{background:rgba(239,68,68,.18)}

footer{opacity:.8;margin-top:28px;font-size:14px;color:var(--muted)}
code.inline{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}

  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo">DW</div>
        <div>
          <div style="font-size:18px">Donate Way</div>
          <div class="tag">منصة تبرعات — أرجواني × أبيض</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="btnLogin" class="btn ghost" title="تسجيل الدخول عبر Pi">تسجيل الدخول</button>
        <button id="btnLogout" class="btn ghost" style="display:none" title="تسجيل الخروج">تسجيل الخروج</button>
      </div>
    </div>
  </header>  <main class="container" style="margin-top:18px">
    <section class="hero">
      <!-- النموذج -->
      <div class="card" id="donateCard">
        <h1 class="heading">ادعم مبادرات الخير عبر
          <span style="background:linear-gradient(90deg,var(--purple-700),var(--purple-400));-webkit-background-clip:text;color:transparent">Pi Network</span>
        </h1>
        <p class="sub">سجّل عبر Pi للتعرّف عليك، ثم اختر المبلغ والغرض وسيتم إنشاء دفعة آمنة عبر <b>Pi SDK</b>.</p><div class="grid-2">
      <div>
        <label>الغرض من التبرع</label>
        <select id="cause" class="select" aria-label="Cause">
          <option value="general">دعم عام</option>
          <option value="education">التعليم</option>
          <option value="health">الصحة</option>
          <option value="poverty">مكافحة الفقر</option>
        </select>
      </div>
      <div>
        <label>ملاحظة (اختياري)</label>
        <input id="memo" class="input" placeholder="اكتب رسالة قصيرة" maxlength="80" />
      </div>
    </div>

    <div class="separator"></div>

    <div style="margin-bottom:10px">اختر المبلغ (π)</div>
    <div class="chips" id="presetChips">
      <div class="chip" data-val="1">1 π</div>
      <div class="chip" data-val="3">3 π</div>
      <div class="chip" data-val="5">5 π</div>
      <div class="chip" data-val="10">10 π</div>
      <div class="chip" data-val="25">25 π</div>
    </div>
    <div style="margin-top:10px" class="grid-2">
      <input id="amount" class="input" inputmode="decimal" placeholder="أو أدخل مبلغًا مخصصًا (π)" />
      <button id="btnDonate" class="btn primary">تبرّع الآن</button>
    </div>

    <div class="separator"></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="userBadge" class="badge warn" style="display:none">لم تسجّل الدخول بعد</div>
      <div id="userInfo" style="color:var(--muted)">غير مسجل — سجّل للدفع عبر Pi</div>
    </div>
  </div>

  <!-- القائمة الجانبية -->
  <aside class="card">
    <h3 style="margin:0 0 6px">آخر التبرعات</h3>
    <div class="stats">
      <div class="stat"><div class="v" id="statCount">0</div><div class="k">عدد المتبرعين</div></div>
      <div class="stat"><div class="v" id="statSum">0 π</div><div class="k">إجمالي التبرعات</div></div>
      <div class="stat"><div class="v" id="statAvg">0 π</div><div class="k">متوسط التبرع</div></div>
    </div>
    <div class="list" id="donorsList"></div>
  </aside>
</section>

<footer>
  <p>
    • يتطلب الدفع الحقيقي عبر <b>Pi Network</b> فتح الموقع داخل <span class="inline">Pi Browser</span> وتوفير خادمين (API)
    لنقاط النهاية <code class="inline">/create-payment</code> و <code class="inline">/complete-payment</code> لتوقيع المعاملة والتحقق منها.<br/>
    • هذا الملف يوفّر <b>الفرونت إند</b> + تكامل SDK من جهة العميل مع مُعالجات افتراضية. عدّل عناوين نقاط النهاية عند تجهيز الخادم.
  </p>
</footer>

  </main>  <div class="toast-area" aria-live="polite" aria-atomic="true"></div>  <script>
    // ===== أدوات سريعة =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const state = {
      user: null,
      donations: JSON.parse(localStorage.getItem('dw_donations') || '[]')
    };
    const saveDonations = () => localStorage.setItem('dw_donations', JSON.stringify(state.donations.slice(0,200)));

    function toast(msg, type='ok', timeout=3000){
      const area = document.querySelector('.toast-area');
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = `<span class="badge ${type}">${type==='ok'?'تم':type==='warn'?'تنبيه':'خطأ'}</span><span>${msg}</span>`;
      area.appendChild(el); setTimeout(()=>el.remove(), timeout);
    }

    function updateStats(){
      const nums = state.donations.map(d=>Number(d.amount)||0);
      const sum = nums.reduce((a,b)=>a+b,0);
      const avg = nums.length ? sum/nums.length : 0;
      $('#statCount').textContent = String(nums.length);
      $('#statSum').textContent = `${sum.toFixed(2)} π`;
      $('#statAvg').textContent = `${avg.toFixed(2)} π`;
    }

    function renderDonors(){
      const list = $('#donorsList'); list.innerHTML='';
      state.donations.slice(-50).forEach(d=>{
        const item = document.createElement('div'); item.className='donor';
        const initials = (d.username||'??').slice(0,2).toUpperCase();
        item.innerHTML = `
          <div class="avatar">${initials}</div>
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
              <strong>${d.username||'مستخدم'}</strong>
              <small>${new Date(d.ts).toLocaleString()}</small>
            </div>
            <small>${d.memo?d.memo+' — ':''}<b>${Number(d.amount).toFixed(2)} π</b> • ${d.cause}</small>
          </div>`;
        list.prepend(item);
      });
      updateStats();
    }

    function setUser(u){
      state.user = u;
      if(u){
        $('#userInfo').innerHTML = `مسجل باسم <b>@${u.username}</b>${u.uid? ' • UID: '+u.uid:''}`;
        $('#btnLogin').style.display='none'; $('#btnLogout').style.display='inline-block';
      } else {
        $('#userInfo').textContent = 'غير مسجل — سجّل للدفع عبر Pi';
        $('#btnLogin').style.display='inline-block'; $('#btnLogout').style.display='none';
      }
    }

    // ===== أزرار المبالغ الجاهزة =====
    $('#presetChips').addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      $$('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active');
      $('#amount').value = chip.dataset.val;
    });

    // ===== تهيئة Pi SDK =====
    let PiRef = null;
    try {
      if(window.Pi){
        window.Pi.init({ version: '2.0' });
        PiRef = window.Pi; console.log('Pi SDK initialized');
      } else {
        console.log('Pi SDK not found (خارج Pi Browser)');
      }
    } catch(err){ console.warn('Pi init error', err); }

    async function loginWithPi(){
      if(!PiRef){ toast('افتح الموقع داخل Pi Browser لتسجيل الدخول الحقيقي.', 'warn'); return; }
      try{
        const scopes = ['username','payments'];
        const res = await PiRef.authenticate(scopes, onIncompletePayment);
        setUser({ username: res.user.username, uid: res.user.uid });
        localStorage.setItem('dw_user', JSON.stringify(state.user));
        toast('تم تسجيل الدخول عبر Pi');
      }catch(err){ console.error(err); toast('فشل تسجيل الدخول: '+(err?.message||''),'err'); }
    }

    function logout(){ localStorage.removeItem('dw_user'); setUser(null); toast('تم تسجيل الخروج'); }

    async function onIncompletePayment(payment){
      // يتم استدعاؤها بواسطة SDK للمدفوعات غير المكتملة
      console.log('Incomplete payment', payment);
    }

    // ===== إستدعاءات الخادم (يجب تعديلها للخادم الحقيقي) =====
    const API_CREATE = '/create-payment';
    const API_COMPLETE = '/complete-payment';

    async function createPaymentOnServer(payload){
      const res = await fetch(API_CREATE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error('CREATE API فشل');
      return res.json();
    }
    async function completePaymentOnServer(payment){
      const res = await fetch(API_COMPLETE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payment) });
      if(!res.ok) throw new Error('COMPLETE API فشل');
      return res.json();
    }

    async function donate(){
      const amountStr = ($('#amount').value||'').replace(/,/g,'.');
      const amount = Number(amountStr);
      const cause = $('#cause').value; const memo = ($('#memo').value||'').trim().slice(0,80);
      if(!amount || amount<=0){ toast('أدخل مبلغًا صحيحًا بالـ π','warn'); return; }

      if(PiRef && state.user){
        // تدفق حقيقي عبر SDK + خادمك
        try{
          toast('جاري إنشاء دفعة Pi...');
          const createPayload = { amount, memo, metadata:{ cause } };
          const serverPayment = await createPaymentOnServer(createPayload);
          const payment = await PiRef.createPayment(serverPayment);
          await completePaymentOnServer(payment);
          // حفظ محلي لعرض القائمة
          state.donations.push({ username: state.user.username, amount, cause, memo, ts: Date.now() });
          saveDonations(); renderDonors();
          toast('تم إنشاء الدفعة — أكملها داخل Pi Browser');
        }catch(err){
          console.error(err);
          toast('تعذّر الربط بالخادم. تم حفظ العملية كمحاكاة محلية.', 'warn');
          state.donations.push({ username: state.user.username, amount, cause, memo, ts: Date.now() });
          saveDonations(); renderDonors();
        }
      } else {
        // محاكاة كاملة خارج Pi Browser أو بدون تسجيل
        toast('محاكاة: قم بتجربة الواجهة. للمدفوعات الحقيقية ادخل عبر Pi وسجّل الدخول.', 'warn');
        state.donations.push({ username: 'زائر', amount, cause, memo, ts: Date.now() });
        saveDonations(); renderDonors();
      }

      // إعادة ضبط اختيار المبالغ
      $$('.chip').forEach(c=>c.classList.remove('active')); $('#amount').value='';
    }

    // ===== ربط الأحداث =====
    $('#btnLogin').addEventListener('click', loginWithPi);
    $('#btnLogout').addEventListener('click', logout);
    $('#btnDonate').addEventListener('click', donate);

    // ===== إستعادة جلسة المستخدم =====
    try{ const u = JSON.parse(localStorage.getItem('dw_user')||'null'); if(u) setUser(u); }catch(_){ }

    // ===== عرض أولي =====
    renderDonors();
  </script></body>
</html>
