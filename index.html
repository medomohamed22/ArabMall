<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pi Chat</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f5; }
    #chat { display: none; max-width: 400px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    #messages { height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; padding: 5px; text-align: left; }
    .msg { margin: 5px 0; }
    .me { color: purple; }
    .other { color: blue; }
    input, button { padding: 8px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
    #searchSection { margin: 20px; }
  </style>
</head>
<body>
  <h2>Pi Chat</h2>
  <button onclick="loginWithPi()">Login with Pi</button>
  
  <div id="searchSection" style="display:none;">
    <input type="text" id="searchUser" placeholder="Enter Pi Username">
    <button onclick="searchUser()">Search</button>
    <p id="searchResult"></p>
  </div>
  
  <div id="chat">
    <h3 id="chatWith"></h3>
    <div id="messages"></div>
    <input type="text" id="msgInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });

    let currentUser = null;
    let chattingWith = null;
    let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "{}");

    async function loginWithPi() {
      try {
        const scopes = ['username'];
        const auth = await Pi.authenticate(scopes, ()=>{});
        currentUser = auth.user.username;
        alert("Logged in as: " + currentUser);
        document.getElementById("searchSection").style.display = "block";
      } catch (err) {
        console.error(err);
      }
    }

    function searchUser() {
      const user = document.getElementById("searchUser").value.trim();
      if (!user) return;

      if (chatHistory[user]) {
        chattingWith = user;
        document.getElementById("chatWith").innerText = "Chat with: " + chattingWith;
        document.getElementById("chat").style.display = "block";
        loadMessages();
        document.getElementById("searchResult").innerText = "";
      } else {
        document.getElementById("searchResult").innerText = "User not found!";
      }
    }

    function sendMessage() {
      const msgText = document.getElementById("msgInput").value.trim();
      if (!msgText || !chattingWith) return;

      if (!chatHistory[chattingWith]) {
        chatHistory[chattingWith] = [];
      }

      chatHistory[chattingWith].push({ sender: currentUser, text: msgText });
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
      document.getElementById("msgInput").value = "";
      loadMessages();
    }

    function loadMessages() {
      const msgBox = document.getElementById("messages");
      msgBox.innerHTML = "";
      if (chatHistory[chattingWith]) {
        chatHistory[chattingWith].forEach(m => {
          const div = document.createElement("div");
          div.className = "msg " + (m.sender === currentUser ? "me" : "other");
          div.innerText = m.sender + ": " + m.text;
          msgBox.appendChild(div);
        });
      }
    }
  </script>
</body>
</html>
