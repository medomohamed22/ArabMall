<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة مدفوعات Pi Network</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            text-align: center;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
        }
        h1 {
            color: #5545c2;
            margin-bottom: 30px;
        }
        .product {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .product img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .product-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #5545c2;
            margin: 10px 0;
        }
        .pay-button {
            background-color: #5545c2;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .pay-button:hover {
            background-color: #443399;
        }
        .footer {
            margin-top: 40px;
            color: #666;
            font-size: 14px;
        }
        .payment-status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            background-color: #f0f0f0;
            display: none;
        }
        .payment-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        .payment-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        .payment-status.pending {
            background-color: #fff3cd;
            color: #856404;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>متجر Pi Network</h1>
        
        <div class="product">
            <img src="/api/placeholder/400/320" alt="منتج">
            <div class="product-info">
                <h2>منتج رائع</h2>
                <p>هذا المنتج الرائع متاح للشراء باستخدام عملة Pi الرقمية.</p>
                <div class="price">5 π</div>
            </div>
            <button id="payWithPi" class="pay-button">ادفع باستخدام Pi</button>
        </div>
        
        <div id="payment-status" class="payment-status"></div>
        
        <div class="footer">
            <p>جميع المدفوعات تتم معالجتها بشكل آمن عبر شبكة Pi Network</p>
        </div>
    </div>

    <!-- Pi Network SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة Pi SDK مع مفتاح API
            const Pi = window.Pi;
            const apiKey = "dpmopijgtltrtr3dvlrhvvzwj3r5tzrkah4susl2xr65djqah2aaeft1btonafck";
            
            // تهيئة SDK مع المفتاح
            Pi.init({ 
                version: "2.0", 
                sandbox: true,
                apiKey: apiKey
            });
            
            // استمع لأحداث الزر
            document.getElementById('payWithPi').addEventListener('click', function() {
                makePayment();
            });
            
            // دالة إجراء المدفوعات
            async function makePayment() {
                try {
                    updatePaymentStatus("جاري تحضير عملية الدفع...", "pending");
                    
                    // تسجيل الدخول باستخدام Pi
                    const authResponse = await Pi.authenticate(['payments'], onIncompletePaymentFound);
                    const user = authResponse.user;
                    
                    updatePaymentStatus("تم تسجيل الدخول كـ " + user.username + ". جاري إنشاء معاملة دفع...", "pending");
                    
                    const paymentData = {
                        amount: 5,
                        memo: "شراء منتج رائع",
                        metadata: { 
                            orderId: "ORDER_" + Math.floor(Math.random() * 1000000),
                            userId: user.uid,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    // إنشاء معاملة دفع
                    const payment = await Pi.createPayment(paymentData);
                    
                    // التحقق من المعاملة وإكمالها
                    const paymentId = payment.identifier;
                    updatePaymentStatus("تم إنشاء معاملة دفع بنجاح. رقم المعاملة: " + paymentId + ". جاري التحقق...", "pending");
                    
                    // إرسال المعاملة للخادم للتحقق منها (هذا سيكون مرتبط بخادم backend حقيقي)
                    // في بيئة حقيقية، ستحتاج إلى معالجة هذا بواسطة خادم backend
                    
                    // محاكاة استدعاء API لتأكيد الدفع
                    simulateApiCall(paymentId, apiKey)
                        .then(response => {
                            if (response.success) {
                                updatePaymentStatus("تمت عملية الدفع بنجاح! رقم المعاملة: " + paymentId, "success");
                            } else {
                                updatePaymentStatus("فشلت عملية الدفع: " + response.message, "error");
                            }
                        })
                        .catch(error => {
                            updatePaymentStatus("حدث خطأ أثناء معالجة الدفع: " + error.message, "error");
                        });
                    
                } catch (error) {
                    updatePaymentStatus("حدث خطأ: " + error.message, "error");
                    console.error(error);
                }
            }
            
            // محاكاة استدعاء API (في البيئة الحقيقية، سيكون هذا طلبًا إلى خادم backend)
            function simulateApiCall(paymentId, apiKey) {
                return new Promise((resolve, reject) => {
                    console.log("إرسال طلب تحقق من الدفع للخادم باستخدام المفتاح: " + apiKey);
                    console.log("رقم معاملة الدفع: " + paymentId);
                    
                    // محاكاة تأخير الشبكة
                    setTimeout(() => {
                        // 90% فرصة نجاح للمحاكاة
                        if (Math.random() < 0.9) {
                            resolve({
                                success: true,
                                paymentId: paymentId,
                                message: "تمت معالجة الدفع بنجاح"
                            });
                        } else {
                            reject({
                                success: false,
                                message: "فشل التحقق من الدفع"
                            });
                        }
                    }, 2000);
                });
            }
            
            // معالج للمدفوعات غير المكتملة
            function onIncompletePaymentFound(payment) {
                updatePaymentStatus("وجدنا معاملة غير مكتملة. رقم المعاملة: " + payment.identifier + ". جاري المعالجة...", "pending");
                console.log("معاملة غير مكتملة:", payment);
                
                // في البيئة الحقيقية، ستتحقق من حالة هذه المعاملة على الخادم الخاص بك
                // وإما إكمالها أو إلغائها
                
                // محاكاة استكمال المعاملة غير المكتملة
                simulateApiCall(payment.identifier, apiKey)
                    .then(response => {
                        if (response.success) {
                            updatePaymentStatus("تم استكمال المعاملة غير المكتملة بنجاح!", "success");
                        } else {
                            updatePaymentStatus("فشل استكمال المعاملة غير المكتملة: " + response.message, "error");
                        }
                    })
                    .catch(error => {
                        updatePaymentStatus("حدث خطأ أثناء معالجة المعاملة غير المكتملة: " + error.message, "error");
                    });
            }
            
            // تحديث حالة الدفع في واجهة المستخدم
            function updatePaymentStatus(message, status) {
                const statusElement = document.getElementById('payment-status');
                statusElement.textContent = message;
                
                // إزالة جميع الفئات السابقة
                statusElement.classList.remove('success', 'error', 'pending');
                
                // إضافة الفئة المناسبة
                if (status) {
                    statusElement.classList.add(status);
                }
            }
        });
    </script>
</body>
</html>
