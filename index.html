<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تبرعات Pi Network</title>
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
  <style>
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #7c3aed, #5b21b6);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      background: rgba(0,0,0,0.6);
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    h1 {
      margin-bottom: 10px;
    }
    p {
      color: #d1c4e9;
      margin-bottom: 20px;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      font-size: 15px;
    }
    input, textarea {
      background: rgba(255,255,255,0.1);
      color: #fff;
      outline: none;
    }
    button {
      background: #7c3aed;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #5b21b6;
    }
    .donations {
      margin-top: 20px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
    .donation-item {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>تبرعات Pi Network</h1>
    <p id="welcome">جاري التحقق من حسابك عبر Pi Network...</p><form id="donationForm">
  <input type="number" id="amount" placeholder="المبلغ (Pi)" min="0.01" step="0.01" required />
  <input type="text" id="name" placeholder="اسمك (اختياري)" />
  <textarea id="note" placeholder="رسالة قصيرة (اختياري)"></textarea>
  <button type="submit">تبرّع الآن</button>
</form>

<div class="donations" id="donationsList"></div>

  </div>  <script>
    const donationsList = document.getElementById("donationsList");
    const welcome = document.getElementById("welcome");
    const STORAGE_KEY = "pi_donations";
    let currentUser = null;

    function loadDonations(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e){ return []; }
    }
    function saveDonations(list){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }
    function renderDonations(){
      const donations = loadDonations();
      donationsList.innerHTML = "";
      donations.slice().reverse().forEach(d => {
        const div = document.createElement("div");
        div.className = "donation-item";
        div.innerHTML = `<b>${d.name||"مجهول"}</b> — ${d.amount} π<br><small>${d.note||""}</small>`;
        donationsList.appendChild(div);
      });
    }

    // تسجيل الدخول عند الدخول مباشرة
    window.addEventListener("load", async () => {
      if(window.Pi){
        Pi.init({ version: "2.0" });
        try {
          const scopes = ["username", "payments"];
          const auth = await Pi.authenticate(scopes, (payment)=>{
            console.log("دفعة غير مكتملة:", payment);
          });
          currentUser = auth.user;
          welcome.textContent = "مرحبًا @" + currentUser.username;
        } catch (e){
          welcome.textContent = "فشل تسجيل الدخول بـ Pi";
        }
      } else {
        welcome.textContent = "⚠️ هذا العرض تجريبي خارج Pi Browser";
      }
      renderDonations();
    });

    // عند التبرع
    document.getElementById("donationForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById("amount").value);
      const name = document.getElementById("name").value;
      const note = document.getElementById("note").value;

      if(!(amount>0)) return alert("أدخل مبلغ صحيح");

      if(window.Pi){
        try{
          const payment = await Pi.createPayment({ amount, memo: "Donation", metadata:{ name, note } }, {
            onReadyForServerApproval: (paymentId)=>{ console.log("Ready for approval:", paymentId); },
            onReadyForServerCompletion: (paymentId)=>{ console.log("Ready for completion:", paymentId); },
            onCancel: ()=> alert("تم إلغاء العملية"),
            onError: (err)=> alert("خطأ في العملية")
          });
          console.log(payment);
        }catch(err){ console.error(err); }
      }

      const donations = loadDonations();
      donations.push({ amount, name, note });
      saveDonations(donations);
      renderDonations();
      document.getElementById("donationForm").reset();
    });
  </script></body>
</html>
