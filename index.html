<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª - Pi Testnet</title>
<style>
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f5f0ff;font-family:sans-serif;direction:rtl}
  .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.1);width:100%;max-width:750px;text-align:center}
  h1{margin-top:0;color:#6b2fb1}
  input{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
  button{background:#6b2fb1;color:#fff;border:0;padding:10px 16px;border-radius:8px;font-weight:bold;cursor:pointer}
  .row{display:flex;gap:10px;margin-bottom:16px}
  .ok{border:2px solid #2fa84f;padding:16px;border-radius:10px;background:#f0fff7;color:#000;margin-top:10px}
  .error{color:#c00;margin-top:10px}
  .label{font-weight:bold;color:#6b2fb1}
  table{width:100%;border-collapse:collapse;margin-top:20px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#eee}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ’œ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª Ø¹Ø¨Ø± Pi Testnet</h1>

    <div id="userSection">
      <button id="loginBtn">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Pi</button>
    </div>

    <div id="donationSection" style="display:none;">
      <p>Ø£Ø¯Ø®Ù„ <b>Transaction Hash</b> Ù„ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª.</p>
      <div class="row">
        <input id="txInput" type="text" placeholder="Ø¶Ø¹ Ù‡Ù†Ø§ tx hash" />
        <button id="checkBtn">ØªØ­Ù‚Ù‚</button>
      </div>
      <div id="result"></div>

      <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</h3>
      <table>
        <thead><tr><th>Ø§Ù„Ù…ØªØ¨Ø±Ø¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (Pi)</th><th>Ø§Ù„Ù…ÙØ±Ø³Ù„</th><th>Ø§Ù„Ù‡Ø§Ø´</th></tr></thead>
        <tbody id="donationsList"></tbody>
      </table>
    </div>
  </div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
const TARGET_WALLET = "GBS27QZJP3RLL4D63Z3523BTY272KUPJE3OFQWA67DASMOH4NIZI2CEP"; 

const loginBtn = document.getElementById('loginBtn');
const userSection = document.getElementById('userSection');
const donationSection = document.getElementById('donationSection');
const checkBtn = document.getElementById('checkBtn');
const txInput = document.getElementById('txInput');
const resultDiv = document.getElementById('result');
const donationsList = document.getElementById('donationsList');

let currentUser = null;

// ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi SDK
loginBtn.addEventListener('click', async () => {
  try {
    const scopes = ['username','payments']; // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const authRes = await window.Pi.authenticate(scopes, onIncompletePaymentFound);
    currentUser = authRes.user.username;

    userSection.innerHTML = `<p>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ <b>${currentUser}</b></p>`;
    donationSection.style.display = "block";
    loadDonations();
  } catch (err) {
    alert("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message);
  }
});

// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
async function checkTx(){
  const hash = txInput.value.trim();
  if(!hash){ resultDiv.innerHTML='<p class="error">âœ‹ Ø£Ø¯Ø®Ù„ Hash Ø£ÙˆÙ„Ø§Ù‹</p>'; return; }

  resultDiv.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
  try{
    const txUrl = `https://api.testnet.minepi.com/transactions/${hash}`;
    const txRes = await fetch(txUrl);
    if(!txRes.ok){ resultDiv.innerHTML=`<p class="error">âš ï¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (HTTP ${txRes.status})</p>`; return; }
    const txData = await txRes.json();
    if(!txData.successful){ resultDiv.innerHTML = `<p class="error">âš ï¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙØ´Ù„Øª</p>`; return; }

    const opUrl = `${txUrl}/operations`;
    const opRes = await fetch(opUrl);
    if(!opRes.ok){ resultDiv.innerHTML=`<p class="error">âš ï¸ Ù„Ù… Ø§Ø³ØªØ·Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>`; return; }
    const opData = await opRes.json();

    let found = false;
    if(opData._embedded && opData._embedded.records){
      for(const op of opData._embedded.records){
        if(op.type === "payment" && op.to === TARGET_WALLET){
          found = true;
          resultDiv.innerHTML = `
            <div class="ok">
              <h3>âœ… ØªÙ… Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ù†Ø¬Ø§Ø­</h3>
              <p><span class="label">Ø§Ù„Ù…ÙØ±Ø³ÙÙ„:</span> ${op.from}</p>
              <p><span class="label">Ø§Ù„Ù…ÙØ³ØªÙ‚Ø¨ÙÙ„:</span> ${op.to}</p>
              <p><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span> ${op.amount} Pi</p>
            </div>`;

          // ğŸ“ Ø­ÙØ¸ Ø§Ù„ØªØ¨Ø±Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Pi
          saveDonation({
            user: currentUser,
            amount: op.amount,
            from: op.from,
            hash: hash
          });

          loadDonations();
          break;
        }
      }
    }

    if(!found){
      resultDiv.innerHTML = `<p class="error">âš ï¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙƒÙ†Ù‡Ø§ Ù„ÙŠØ³Øª Ù„Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.</p>`;
    }

  }catch(err){
    resultDiv.innerHTML = `<p class="error">âš ï¸ Ø®Ø·Ø£: ${err.message}</p>`;
  }
}

checkBtn.addEventListener('click', checkTx);
txInput.addEventListener('keydown', e=>{ if(e.key==="Enter") checkTx(); });

// ğŸ—‚ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„ØªØ¨Ø±Ø¹Ø§Øª
function saveDonation(donation){
  let donations = JSON.parse(localStorage.getItem('donations') || "[]");
  donations.push(donation);
  localStorage.setItem('donations', JSON.stringify(donations));
}

function loadDonations(){
  donationsList.innerHTML = "";
  let donations = JSON.parse(localStorage.getItem('donations') || "[]");
  donations.forEach(d=>{
    donationsList.innerHTML += `<tr>
      <td>${d.user}</td>
      <td>${d.amount}</td>
      <td>${d.from}</td>
      <td>${d.hash}</td>
    </tr>`;
  });
}

// ğŸ” Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† SDK (ÙˆØ¸ÙŠÙØ© Callback Ù„Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©)
function onIncompletePaymentFound(payment){
  console.log("ğŸ”” Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©:", payment);
}
</script>
</body>
</html>
